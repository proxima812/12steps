---
import PostCard from "@/components/PostCard.astro";
import Search from "@/components/Search";
import TagsNav from "@/components/TagsNav.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { customSlugify } from "@/utils/libs/customSlugify";
import { getSinglePage } from "@/utils/libs/getSinglePage";


export async function getStaticPaths() {
  const allPosts = await getSinglePage("posts");
  const uniqueTags = [
    ...new Set(allPosts.map((post) => post.data.tags).flat()),
  ];

  return uniqueTags.map((tag) => {
    const filteredPosts = allPosts.filter((post) =>
      post.data.tags.includes(tag),
    );
    return {
      params: { tag: customSlugify(tag) },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
const bookmarks = (Astro.cookies.get("bookmarks")?.json() || []) as IBookmark[];
---

<BaseLayout
  container_max_w="max-w-6xl"
  title={`Постов по тегу: (${posts.length})`}
>
  <TagsNav />
   <Search
    client:visible
    classNameMainDiv="max-w-full"
    classNameIcon="ring-1 ring-inset dark:bg-zinc-800 bg-zinc-100 ring-zinc-200 dark:ring-white/20"
    classNameSearch="ring-1 ring-inset ring-zinc-200 dark:ring-white/20"
    postsList={posts}
  />
  <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
       {
      posts.map(async (item: any) => {
        const isChecked = bookmarks.some((bookmark) => bookmark.id === item.id);
        return (
          <PostCard
            isChecked={isChecked}
            item={item.id}
            slug={item.slug}
            data={item.data}
          />
        );
      })
    }
  </div>
    <script>
    import type { IBookmark } from "@/types/global";
import { getCookie, setCookie } from "@/utils/cookie"
import { navigate } from "astro:transitions/client"

    document.addEventListener("DOMContentLoaded", () => {
      const url = new URL(window.location.href);
      const hasBookmarkPage = url.pathname.includes("bookmarks");
      const bookmarkButtons = document.querySelectorAll("[data-bookmark]");

      function parseBookmarks(bookmarks: string) {
        return JSON.parse(bookmarks) as IBookmark[];
      }

      function stringifyBookmarks(bookmarks: IBookmark[]) {
        return JSON.stringify(bookmarks);
      }

      Array.from(bookmarkButtons).forEach((button) =>
        button.addEventListener("click", (e) => {
          const targetElement = e.currentTarget as HTMLButtonElement;
          const id = targetElement.dataset.value as string;

          let bookmarks = getCookie("bookmarks") || "[]";

          const parsedBookmarks = parseBookmarks(bookmarks);
          const bookmarkExists = parsedBookmarks.find((item) => item.id === id);

          const bookmark = {
            id,
            date: new Date().toUTCString(),
          };

          targetElement.dataset.checked = bookmarkExists ? "false" : "true";

          const updatedBookmarks = bookmarkExists
            ? parsedBookmarks.filter((item) => item.id !== id)
            : [...parsedBookmarks, bookmark];

          setCookie("bookmarks", stringifyBookmarks(updatedBookmarks));

          if (hasBookmarkPage && bookmarkExists) {
            navigate("/bookmarks");
          }
        }),
      );
    });
  </script>
</BaseLayout>
